<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Diana's Naughty Dash</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      display: none;
      background: #222;
      border: 2px solid #fff;
    }
    #startBtn {
      font-size: 24px;
      padding: 20px 40px;
      background-color: hotpink;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #startBtn:hover {
      background-color: deeppink;
    }
  </style>
</head>
<body>
  <button id="startBtn">Start Diana's Naughty Dash</button>
  <canvas id="game" width="800" height="400"></canvas>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");

    const dianaImg = new Image();
    dianaImg.src = "diana.png";

    const bgImg = new Image();
    bgImg.src = "Hills.png";

    const ballImg = new Image();
    ballImg.src = "Ball.png";

    const jumpSound = new Audio("Jump.mp3");
    const hitSound = new Audio("Hit.mp3");
    const bgMusic = new Audio("Desert.mp3");
    bgMusic.loop = true;
    bgMusic.volume = 0.4;

    const player = {
      x: 50, y: 300, width: 60, height: 120, dy: 0, jumping: false, speed: 4
    };

    const gravity = 0.5;
    const groundY = canvas.height - 80;

    const enemy = { x: 900, y: groundY - 60, width: 60, height: 60 };

    let bgX = 0;
    const keys = {};
    let score = 0;
    let highScore = 0;

    const speech = { text: "", timer: 0 };

    const jumpMessages = [
      "Ooo that felt nice", "I'm good at this", "This is fun",
      "You're good", "Keep pressing my buttons"
    ];

    const failMessages = [
      "Damn, I missed", "I'll get it next time", "I need to practice my jumping"
    ];

    function showSpeech(message, duration = 60) {
      speech.text = message;
      speech.timer = duration;
    }

    function getRandomMessage(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    window.addEventListener("keydown", (e) => {
      keys[e.key] = true;
      if ((e.key === " " || e.key === "ArrowUp") && !player.jumping) {
        player.dy = -12;
        player.jumping = true;
        score++;
        if (score > highScore) highScore = score;
        jumpSound.currentTime = 0;
        jumpSound.play();
        showSpeech(getRandomMessage(jumpMessages), 60);
      }
    });

    window.addEventListener("keyup", (e) => keys[e.key] = false);

    function drawBackground() {
      bgX -= 2;
      if (bgX <= -canvas.width) bgX = 0;
      ctx.drawImage(bgImg, bgX, 0, canvas.width, canvas.height);
      ctx.drawImage(bgImg, bgX + canvas.width, 0, canvas.width, canvas.height);
    }

    function roundRect(ctx, x, y, width, height, radius) {
      if (width < 2 * radius) radius = width / 2;
      if (height < 2 * radius) radius = height / 2;
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.arcTo(x + width, y, x + width, y + height, radius);
      ctx.arcTo(x + width, y + height, x, y + height, radius);
      ctx.arcTo(x, y + height, x, y, radius);
      ctx.arcTo(x, y, x + width, y, radius);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }

    // *** Fixed drawSpeechBubble function ***
    function drawSpeechBubble(text, x, y) {
      ctx.font = "14px 'Segoe UI'";
      const maxWidth = 160;
      const paddingX = 15;
      const paddingY = 10;
      const words = text.split(" ");
      const lines = [];
      let currentLine = "";

      for (let word of words) {
        const testLine = currentLine + word + " ";
        const testWidth = ctx.measureText(testLine).width;
        if (testWidth > maxWidth && currentLine !== "") {
          lines.push(currentLine.trim());
          currentLine = word + " ";
        } else {
          currentLine = testLine;
        }
      }
      lines.push(currentLine.trim());

      const lineHeight = 18;
      const bubbleWidth = maxWidth + paddingX * 2;
      const bubbleHeight = lines.length * lineHeight + paddingY * 2;
      const bubbleX = x - bubbleWidth / 2 + player.width / 2; // center bubble horizontally above player
      const bubbleY = y - bubbleHeight - 30;

      // Draw bubble background
      ctx.fillStyle = "rgba(255, 255, 255, 0.85)";
      ctx.strokeStyle = "#222";
      ctx.lineWidth = 2;
      roundRect(ctx, bubbleX, bubbleY, bubbleWidth, bubbleHeight, 12);

      // Draw tail
      ctx.beginPath();
      ctx.moveTo(bubbleX + bubbleWidth / 2 - 10, bubbleY + bubbleHeight);
      ctx.lineTo(bubbleX + bubbleWidth / 2, bubbleY + bubbleHeight + 10);
      ctx.lineTo(bubbleX + bubbleWidth / 2 + 10, bubbleY + bubbleHeight);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // Draw text inside bubble
      ctx.fillStyle = "#222";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";

      for (let i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i], bubbleX + paddingX, bubbleY + paddingY + i * lineHeight);
      }
    }

    function drawPlayer() {
      ctx.drawImage(dianaImg, player.x, player.y, player.width, player.height);
      if (speech.timer > 0 && speech.text) {
        drawSpeechBubble(speech.text, player.x, player.y);
      }
    }

    function drawEnemy() {
      ctx.drawImage(ballImg, enemy.x, enemy.y, enemy.width, enemy.height);
    }

    function drawUI() {
      ctx.textAlign = "right";
      ctx.fillStyle = "#FFD700";
      ctx.font = "bold 28px Arial";
      ctx.fillText("Score: " + score, canvas.width - 20, 40);

      ctx.fillStyle = "#FF69B4";
      ctx.font = "16px Arial";
      ctx.fillText("High Score: " + highScore, canvas.width - 20, 65);
    }

    function updateGame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground();

      if (keys["ArrowRight"]) player.x += player.speed;
      if (keys["ArrowLeft"]) player.x -= player.speed;

      player.dy += gravity;
      player.y += player.dy;

      if (player.y + player.height >= groundY) {
        player.y = groundY - player.height;
        player.dy = 0;
        player.jumping = false;
      }

      enemy.x -= 6;
      if (enemy.x + enemy.width < 0) {
        enemy.x = 800 + Math.random() * 300;
      }

      if (
        player.x < enemy.x + enemy.width &&
        player.x + player.width > enemy.x &&
        player.y < enemy.y + enemy.height &&
        player.y + player.height > enemy.y
      ) {
        hitSound.currentTime = 0;
        hitSound.play();
        showSpeech(getRandomMessage(failMessages), 80);
        alert("ðŸ’¥ Diana bumped into the Ball! Naughty Game Over!");
        resetGame();
      }

      drawPlayer();
      drawEnemy();
      drawUI();

      if (speech.timer > 0) speech.timer--;

      requestAnimationFrame(updateGame);
    }

    function resetGame() {
      player.x = 50;
      player.y = groundY - player.height;
      player.dy = 0;
      enemy.x = 900;
      score = 0;
    }

    function startGame() {
      startBtn.style.display = "none";
      canvas.style.display = "block";
      bgMusic.play();
      resetGame();
      updateGame();
    }

    startBtn.addEventListener("click", startGame);

  </script>
</body>
</html>
